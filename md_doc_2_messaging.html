<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VRDR .NET: Using the VRDR.Messaging Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">VRDR .NET
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Using the VRDR.Messaging Library</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md126"></a> This document describes how to use the VRDR.Messaging library to simplify implementation of <a class="el" href="namespace_v_r_d_r.html">VRDR</a> message exchange flows.</p>
<h1><a class="anchor" id="autotoc_md127"></a>
Death Record Submission</h1>
<p>The diagram below illustrates the messages exchanged during submission of a death record and the subsequent return of coded causes of death and race and ethnicity information.</p>
<p><img src="submission.png" alt="Message Exchange Pattern for Death Record Submission and Coding Response" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md128"></a>
Submit Death Record</h2>
<p>A vital records jurisdiction can create a death record submission as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line">DeathRecord record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a JSON representation of the message (XML is also supported via the ToXML method)</span></div>
<div class="line"><span class="keywordtype">string</span> jsonMessage = message.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>The <code>DeathRecordSubmission</code> constructor will extract information from the supplied <code>DeathRecord</code> to populate the corresponding message property values (<code>StateAuxiliaryIdentifier</code>, <code>CertificateNumber</code>, <code>NCHSIdentifier</code>) automatically.</p>
<h2><a class="anchor" id="autotoc_md129"></a>
Extract Death Record</h2>
<p>On receipt of a message, NCHS can parse it, determine the type of the message, and extract a death record using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> DeathRecordSubmission submission:</div>
<div class="line">        var record = submission.DeathRecord;</div>
<div class="line">        var nchsId = submission.NCHSIdentifier;</div>
<div class="line">        ProcessSubmission(record, nchsId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md130"></a>
Acknowledge Death Record</h2>
<p>If extraction was succesful, NCHS can generate an acknowledgement message and send it to the submitting jurisdiction. An <code>AckMessage</code> constructor is available that accepts a source message parameter (<code>submission</code> in the example below) and this is used to initialize <code>AckMessage</code> properties:</p>
<ul>
<li><code>AckMessage.MessageDestination</code> will be assigned the value of <code>source.MessageSource</code></li>
<li><code>AckMessage.MessageSource</code> will be assigned the value of <code>source.MessageDestination</code></li>
<li><code>AckMessage.AckedMessageId</code> will be assigned the value of <code>source.MessageId</code></li>
<li><code>StateAuxiliaryIdentifier</code> will be assigned the value of <code>source.StateAuxiliaryIdentifier</code></li>
<li><code>CertificateNumber</code> will be assigned the value of <code>source.CertificateNumber</code></li>
<li><code>NCHSIdentifier</code> will be assigned the value of <code>source.NCHSIdentifier</code></li>
</ul>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(submission);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>On receipt of the <code>AckMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line">BaseMessage message = BaseMessage.Parse(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.NCHSIdentifier;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md131"></a>
Return Coding</h2>
<p>NCHS codes both causes of death, and race and ethnicity of decedents. The VRDR.Messaging library supports returning these two types of information separately, using the classes <code>CauseofDeathCodingResponseMessage</code> and <code>DemographicsCodingResponseMessage</code>.</p>
<p>Once NCHS have determined the causes of death they can create a <code>CauseOfDeathCodingResponseMessage</code> to return that information to the jurisdiction:</p>
<div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_v_r_d_r.html">VRDR</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create an empty IJE Mortality record</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_i_j_e_mortality.html">IJEMortality</a> ije = <span class="keyword">new</span> <a class="code hl_class" href="class_v_r_d_r_1_1_i_j_e_mortality.html">IJEMortality</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Populate the IJE fields</span></div>
<div class="line">ije.DOD_YR = <span class="stringliteral">&quot;2022&quot;</span>;</div>
<div class="line">ije.DSTATE = <span class="stringliteral">&quot;YC&quot;</span>;</div>
<div class="line">ije.FILENO = <span class="stringliteral">&quot;123&quot;</span>;</div>
<div class="line">ije.AUXNO = <span class="stringliteral">&quot;500&quot;</span>;</div>
<div class="line">ije.ACME_UC = <span class="stringliteral">&quot;T273&quot;</span>;</div>
<div class="line">ije.RAC = <span class="stringliteral">&quot;T273 T270 &quot;</span>;</div>
<div class="line">ije.EAC = <span class="stringliteral">&quot;11T273  21T270 &amp;&quot;</span>;</div>
<div class="line">ije.R_YR = <span class="stringliteral">&quot;2019&quot;</span>;</div>
<div class="line">ije.R_MO = <span class="stringliteral">&quot;11&quot;</span>;</div>
<div class="line">ije.R_DY = <span class="stringliteral">&quot;14&quot;</span>;</div>
<div class="line">ije.INT_REJ = <span class="stringliteral">&quot;4&quot;</span>;</div>
<div class="line">ije.SYS_REJ = <span class="stringliteral">&quot;3&quot;</span>;</div>
<div class="line">ije.TRX_FLG = <span class="stringliteral">&quot;5&quot;</span>;</div>
<div class="line">ije.MANNER = <span class="stringliteral">&quot;A&quot;</span>;</div>
<div class="line">ije.INJPL = <span class="stringliteral">&quot;7&quot;</span>;</div>
<div class="line">ije.DOI_YR = <span class="stringliteral">&quot;2022&quot;</span>;</div>
<div class="line">ije.DOI_MO = <span class="stringliteral">&quot;1&quot;</span>;</div>
<div class="line">ije.DOI_DY = <span class="stringliteral">&quot;15&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Populate the fields that only appear in TRX records and not IJE</span></div>
<div class="line">ije.trx.CS = <span class="stringliteral">&quot;8&quot;</span>;</div>
<div class="line">ije.trx.SHIP = <span class="stringliteral">&quot;876&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_cause_of_death_coding_message.html">CauseOfDeathCodingMessage</a> message = <span class="keyword">new</span> <a class="code hl_class" href="class_v_r_d_r_1_1_cause_of_death_coding_message.html">CauseOfDeathCodingMessage</a>(ije.<a class="code hl_function" href="class_v_r_d_r_1_1_i_j_e_mortality.html#a5e7144755845cac83d704a7917014ad5">ToDeathRecord</a>());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set the source and destination</span></div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;http://nchs.cdc.gov/vrdr_submission&quot;</span>;</div>
<div class="line">message.MessageDestination = <span class="stringliteral">&quot;https://example.org/jurisdiction/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a JSON representation of the coding response message</span></div>
<div class="line"><span class="keywordtype">string</span> jsonMessage = message.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#ad93e5924c25c3b1eb29c316a47e25f1d">ToJSON</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_base_message_html_ad93e5924c25c3b1eb29c316a47e25f1d"><div class="ttname"><a href="class_v_r_d_r_1_1_base_message.html#ad93e5924c25c3b1eb29c316a47e25f1d">VRDR.BaseMessage.ToJSON</a></div><div class="ttdeci">string ToJSON(bool prettyPrint=false)</div><div class="ttdoc">Helper method to return a JSON string representation of this DeathRecordSubmissionMessage.</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:162</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_cause_of_death_coding_message_html"><div class="ttname"><a href="class_v_r_d_r_1_1_cause_of_death_coding_message.html">VRDR.CauseOfDeathCodingMessage</a></div><div class="ttdoc">A CauseOfDeathCodingMessage that conveys the coded cause of death information of a decedent.</div><div class="ttdef"><b>Definition</b> CauseOfDeathCodingMessage.cs:11</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_i_j_e_mortality_html"><div class="ttname"><a href="class_v_r_d_r_1_1_i_j_e_mortality.html">VRDR.IJEMortality</a></div><div class="ttdoc">A &quot;wrapper&quot; class to convert between a FHIR based DeathRecord and a record in IJE Mortality format....</div><div class="ttdef"><b>Definition</b> IJEMortality.cs:54</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_i_j_e_mortality_html_a5e7144755845cac83d704a7917014ad5"><div class="ttname"><a href="class_v_r_d_r_1_1_i_j_e_mortality.html#a5e7144755845cac83d704a7917014ad5">VRDR.IJEMortality.ToDeathRecord</a></div><div class="ttdeci">DeathRecord ToDeathRecord()</div><div class="ttdoc">Returns the corresponding DeathRecord for this IJE string.</div><div class="ttdef"><b>Definition</b> IJEMortality.cs:219</div></div>
<div class="ttc" id="anamespace_v_r_d_r_html"><div class="ttname"><a href="namespace_v_r_d_r.html">VRDR</a></div><div class="ttdef"><b>Definition</b> Program.cs:21</div></div>
</div><!-- fragment --><p>Similarly, NCHS can create a <code>DemographicsCodingResponseMessage</code> to convey coding information about the decedent's demographics.</p>
<div class="fragment"><div class="line"><span class="keyword">using </span><a class="code hl_namespace" href="namespace_v_r_d_r.html">VRDR</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create an empty IJE Mortality record</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_i_j_e_mortality.html">IJEMortality</a> ije = <span class="keyword">new</span> <a class="code hl_class" href="class_v_r_d_r_1_1_i_j_e_mortality.html">IJEMortality</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Populate the IJE fields</span></div>
<div class="line">ije.DOD_YR = <span class="stringliteral">&quot;2022&quot;</span>;</div>
<div class="line">ije.DSTATE = <span class="stringliteral">&quot;YC&quot;</span>;</div>
<div class="line">ije.FILENO = <span class="stringliteral">&quot;123&quot;</span>;</div>
<div class="line">ije.AUXNO = <span class="stringliteral">&quot;500&quot;</span>;</div>
<div class="line">ije.DETHNIC1 = <span class="stringliteral">&quot;Y&quot;</span>;</div>
<div class="line">ije.DETHNIC2 = <span class="stringliteral">&quot;N&quot;</span>;</div>
<div class="line">ije.RACE1 = <span class="stringliteral">&quot;Y&quot;</span>;</div>
<div class="line">ije.RACE2 = <span class="stringliteral">&quot;N&quot;</span>;</div>
<div class="line">ije.RACE16 = <span class="stringliteral">&quot;Cheyenne&quot;</span>;</div>
<div class="line">ije.RACE1E = <span class="stringliteral">&quot;199&quot;</span>;</div>
<div class="line">ije.RACE16C = <span class="stringliteral">&quot;B40&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Populate the fields that only appear in MRE records and not IJE</span></div>
<div class="line">ije.mre.RECODE40 = <span class="stringliteral">&quot;88&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_demographics_coding_message.html">DemographicsCodingMessage</a> message = <span class="keyword">new</span> <a class="code hl_class" href="class_v_r_d_r_1_1_demographics_coding_message.html">DemographicsCodingMessage</a>(ije.<a class="code hl_function" href="class_v_r_d_r_1_1_i_j_e_mortality.html#a5e7144755845cac83d704a7917014ad5">ToDeathRecord</a>());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set the source and destination</span></div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;http://nchs.cdc.gov/vrdr_submission&quot;</span>;</div>
<div class="line">message.MessageDestination = <span class="stringliteral">&quot;https://example.org/jurisdiction/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a JSON representation of the coding response message</span></div>
<div class="line"><span class="keywordtype">string</span> jsonMessage = message.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#ad93e5924c25c3b1eb29c316a47e25f1d">ToJSON</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_demographics_coding_message_html"><div class="ttname"><a href="class_v_r_d_r_1_1_demographics_coding_message.html">VRDR.DemographicsCodingMessage</a></div><div class="ttdoc">A DemographicsCodingMessage that conveys the coded demographics information of a decedent.</div><div class="ttdef"><b>Definition</b> DemographicsCodingMessage.cs:11</div></div>
</div><!-- fragment --><p>Note that the <code>CauseOfDeathCodingUpdateMessage</code> and <code>DemographicsCodingUpdateMessage</code> classes support the same constructor and properties as their corresponding initial coding response classes. If a second coding message is needed to return causes of death coding or race and ethnicity coding, then the same code as above can be used substituting <code>CauseOfDeathCodingUpdateMessage</code> for <code>CauseOfDeathCodingResponseMessage</code> or <code>DemographicsCodingUpdateMessage</code> for <code>DemographicsCodingResponseMessage</code>.</p>
<p>On receipt of the <code>CodingResponseMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a> message = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code hl_class" href="class_v_r_d_r_1_1_cause_of_death_coding_message.html">CauseOfDeathCodingMessage</a> codingResponse:</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;\nUnderlying COD: {codingResponse.DeathRecord.AutomatedUnderlyingCOD}\n&quot;</span>);</div>
<div class="line">        Console.WriteLine(<span class="stringliteral">&quot;Record Axis Codes:&quot;</span>);</div>
<div class="line">        <span class="keywordflow">foreach</span> (var entry <span class="keywordflow">in</span> codingResponse.DeathRecord.RecordAxisCauseOfDeath)</div>
<div class="line">        {</div>
<div class="line">            Console.WriteLine($<span class="stringliteral">&quot;  Position: {entry.Position}  Code: {entry.Code}&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        Console.WriteLine(<span class="stringliteral">&quot;\nEntity Axis Codes:&quot;</span>);</div>
<div class="line">        <span class="keywordflow">foreach</span> (var entry <span class="keywordflow">in</span> codingResponse.DeathRecord.EntityAxisCauseOfDeath)</div>
<div class="line">        {</div>
<div class="line">            Console.WriteLine($<span class="stringliteral">&quot;  Line: {entry.LineNumber}  Position: {entry.Position}  Code: {entry.Code}&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        Console.WriteLine();</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> <a class="code hl_class" href="class_v_r_d_r_1_1_demographics_coding_message.html">DemographicsCodingMessage</a> codingResponse:</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;First Edited Race Code: {codingResponse.DeathRecord.FirstEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Second Edited Race Code: {codingResponse.DeathRecord.SecondEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Third Edited Race Code: {codingResponse.DeathRecord.ThirdEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Fourth Edited Race Code: {codingResponse.DeathRecord.FourthEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Fifth Edited Race Code: {codingResponse.DeathRecord.FifthEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Sixth Edited Race Code: {codingResponse.DeathRecord.SixthEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Seventh Edited Race Code: {codingResponse.DeathRecord.SeventhEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Eighth Edited Race Code: {codingResponse.DeathRecord.EighthEditedRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;First American Indian Race Code: {codingResponse.DeathRecord.FirstAmericanIndianRaceCodeHelper}&quot;</span>);</div>
<div class="line">        Console.WriteLine($<span class="stringliteral">&quot;Second American Indian Race Code: {codingResponse.DeathRecord.SecondAmericanIndianRaceCodeHelper}&quot;</span>);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_base_message_html"><div class="ttname"><a href="class_v_r_d_r_1_1_base_message.html">VRDR.BaseMessage</a></div><div class="ttdoc">Class BaseMessage is the base class of all messages.</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:13</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_base_message_html_a0d91912a93701d9daaf8e0ab6f3ea0f9"><div class="ttname"><a href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">VRDR.BaseMessage.Parse</a></div><div class="ttdeci">static BaseMessage Parse(string source, bool permissive=false)</div><div class="ttdoc">Parse an XML or JSON serialization of a FHIR Bundle and construct the appropriate subclass of BaseMes...</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:471</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md132"></a>
Acknowledge Coding</h2>
<p>If extraction of the coding information was successful, the jurisdiction can generate an acknowledgement message and send it to NCHS. As described earlier, the <code>AckMessage</code> constructor initializes properties based on the source coding message.</p>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(coding);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>On receipt of the <code>AckMessage</code>, NCHS can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a> message = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.<a class="code hl_property" href="class_v_r_d_r_1_1_base_message.html#ab7faf369e4d89d044c196a2d1c3394e8">NCHSIdentifier</a>;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_base_message_html_ab7faf369e4d89d044c196a2d1c3394e8"><div class="ttname"><a href="class_v_r_d_r_1_1_base_message.html#ab7faf369e4d89d044c196a2d1c3394e8">VRDR.BaseMessage.NCHSIdentifier</a></div><div class="ttdeci">string NCHSIdentifier</div><div class="ttdoc">NCHS identifier. Format is 4-digit year, two character jurisdiction id, six character/digit certifica...</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:397</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md133"></a>
Failed Death Record Submission</h1>
<p>The diagram below illustrates two message extraction failures:</p>
<ol type="1">
<li>A Death Record Submission could not be extracted from the message and an Extraction Error Response is returned instead of an Acknowledgement.</li>
<li>A Coding Response could not be extracted from the message and an Extraction Error Response is returned instead of an acknowledgement.</li>
</ol>
<p><img src="error.png" alt="Message Exchange Patterns for Failed Message Extraction" class="inline"/></p>
<p>Use of the API to create the Death Record Submission, Acknowledgement and Coding Response messages is identical to that shown above and is not repeated here.</p>
<h2><a class="anchor" id="autotoc_md134"></a>
Create an Extraction Error Message</h2>
<div class="fragment"><div class="line">DeathRecordSubmission submissionMessage = <span class="keyword">null</span>;</div>
<div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    submissionMessage = ...;</div>
<div class="line">    ExtractSubmission(submissionMessage);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create the extraction error message and initialize from properties of the submissionMessage</span></div>
<div class="line">    var errMsg = <a class="code hl_class" href="class_v_r_d_r_1_1_extraction_error_message.html">ExtractionErrorMessage</a>(submissionMessage);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Add the issues found during processing</span></div>
<div class="line">    var issues = <span class="keyword">new</span> List&lt;Issue&gt;();</div>
<div class="line">    var issue = <span class="keyword">new</span> <a class="code hl_class" href="class_v_r_d_r_1_1_issue.html">Issue</a>(OperationOutcome.IssueSeverity.Fatal, OperationOutcome.IssueType.Invalid, ex.Message);</div>
<div class="line">    issues.Add(issue);</div>
<div class="line">    errMsg.Issues = issues;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create a JSON representation of the coding error response message</span></div>
<div class="line">    <span class="keywordtype">string</span> jsonErrMsg = errMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Send the JSON extraction error response message</span></div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_extraction_error_message_html"><div class="ttname"><a href="class_v_r_d_r_1_1_extraction_error_message.html">VRDR.ExtractionErrorMessage</a></div><div class="ttdoc">Class ExtractionErrorMessage is used to communicate that initial processing of a DeathRecordSubmissio...</div><div class="ttdef"><b>Definition</b> ErrorMessage.cs:9</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_issue_html"><div class="ttname"><a href="class_v_r_d_r_1_1_issue.html">VRDR.Issue</a></div><div class="ttdoc">Class representing an issue detected during message processing.</div><div class="ttdef"><b>Definition</b> ErrorMessage.cs:117</div></div>
</div><!-- fragment --><p>Note that the <code>ExtractionErrorMessage</code> constructor shown above will automatically set the message header properties and copy the business identifier properties (<code>CertificateNumber</code>, <code>StateAuxiliaryIdentifier</code> and <code>NCHSIdentifier</code>) from the supplied <code>DeathRecordSubmission</code>. If the supplied message is <code>null</code> these message properties will need to be set manually instead (not shown).</p>
<h1><a class="anchor" id="autotoc_md135"></a>
Voiding a Death Record</h1>
<p>The diagram below illustrates the sequence of message exchanges between a vital records jurisdiction and NVSS when an initial submission needs to be subsequently voided. Depending on timing, the initial submission may result in a Coding Response or not.</p>
<p><img src="void.png" alt="Message Exchange Pattern for Voiding a Prior Submission" class="inline"/></p>
<p>It is also possible for a jurisdiction to send a <code>VoidMessage</code> to notify NCHS that a particular certificate identifier will not be used in the future. In this case, only the Death Record Void and corresponding Acknowledgement messages from the diagram above are used.</p>
<h2><a class="anchor" id="autotoc_md136"></a>
Create a Void Messsage</h2>
<p>There are two ways to create a <code>VoidMessage</code>, the first requires a <code>DeathRecord</code> for the record that will be voided:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_death_record.html">DeathRecord</a> record = ...;</div>
<div class="line">var voidMsg = <span class="keyword">new</span> VoidMessage(record);</div>
<div class="line">voidMsg.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_death_record_html"><div class="ttname"><a href="class_v_r_d_r_1_1_death_record.html">VRDR.DeathRecord</a></div><div class="ttdoc">Class DeathRecord models a FHIR Vital Records Death Reporting (VRDR) Death Record....</div><div class="ttdef"><b>Definition</b> DeathRecord_constructors.cs:26</div></div>
</div><!-- fragment --><p>The second method of creating a <code>VoidMessage</code> relies on manual setting of record identifiers:</p>
<div class="fragment"><div class="line">var voidMsg = <span class="keyword">new</span> VoidMessage();</div>
<div class="line">voidMsg.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line">voidMsg.CertificateNumber = <span class="stringliteral">&quot;1034&quot;</span>;</div>
<div class="line">voidMsg.StateAuxiliaryIdentifier = <span class="stringliteral">&quot;A10F3&quot;</span>;</div>
<div class="line">voidMsg.NCHSIdentifier = <span class="stringliteral">&quot;2020MA001034&quot;</span>;</div>
</div><!-- fragment --><p>In both cases the <code>MessageDestination</code> property value is defaulted to <code><a href="http://nchs.cdc.gov/vrdr_submission">http://nchs.cdc.gov/vrdr_submission</a></code> which is the value that should be used for messages sent to NCHS. A JSON representation of the message can be obtained as follows:</p>
<div class="fragment"><div class="line">var jsonVoidMsg = voidMsg.ToJSON();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md137"></a>
Extract Void Information</h2>
<p>On receipt of a message, NCHS can parse it, determine the type of the message, and extract the void record information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a> message = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> VoidMessage voidMsg:</div>
<div class="line">        var nchsId = voidMsg.<a class="code hl_property" href="class_v_r_d_r_1_1_base_message.html#ab7faf369e4d89d044c196a2d1c3394e8">NCHSIdentifier</a>;</div>
<div class="line">        var certNo = voidMsg.CertificateNumber;</div>
<div class="line">        var stateAuxId = voidMsg.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessVoid(nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md138"></a>
Acknowledge Void Message</h2>
<p>NCHS can generate an acknowledgement message and send it to jurisdiction as follows.</p>
<div class="fragment"><div class="line"><span class="comment">// Create the acknowledgement message</span></div>
<div class="line">var ackMsg = <span class="keyword">new</span> AckMessage(voidMsg);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Serialize the acknowledgement message</span></div>
<div class="line"><span class="keywordtype">string</span> ackMsgJson = ackMsg.ToJSON();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the JSON message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>As described earlier, the <code>AckMessage</code> constructor initializes properties based on the source <code>VoidMessage</code> negating the need to initialize its properties manually.</p>
<h2><a class="anchor" id="autotoc_md139"></a>
Process Acknowledgement</h2>
<p>On receipt of the <code>AckMessage</code>, the jurisdiction can parse it, determine the type of the message, and extract the required information using the following steps:</p>
<div class="fragment"><div class="line"><span class="comment">// Get the message as a stream</span></div>
<div class="line">StreamReader messageStream = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Parse the message</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a> message = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageStream);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch to determine the type of message</span></div>
<div class="line"><span class="keywordflow">switch</span>(message)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">case</span> AckMessage ack:</div>
<div class="line">        var ackedMsgId = ack.AckedMessageId;</div>
<div class="line">        var nchsId = ack.<a class="code hl_property" href="class_v_r_d_r_1_1_base_message.html#ab7faf369e4d89d044c196a2d1c3394e8">NCHSIdentifier</a>;</div>
<div class="line">        var certNo = ack.CertificateNumber;</div>
<div class="line">        var stateAuxId = ack.StateAuxiliaryIdentifier;</div>
<div class="line">        ProcessAck(ackedMsgId, nchsId, certNo, stateAuxId);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md140"></a>
Retrying Failed Deliveries</h1>
<p>The diagram below illustrates the case where the vital records jurisdiction does not receive a timely Acknowledgement to a Death Record Submission. To recover, the vital records jurisdiction resends the Death Record Submission.</p>
<p><img src="retry.png" alt="Message Exchange Pattern for Voiding a Prior Submission" class="inline"/></p>
<p>In order to identify whether a message has been received previously, NVSS can compare the message id to those of previously received messages. For this mechanism to work, resent messages must have the same message id as the original.</p>
<p>There are two approaches to creating a message with the same id as a previous message. In the first example below, the id of the original message is saved and then used to set the id of the resent message.</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_death_record.html">DeathRecord</a> record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the submission message</span></div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Store the sent message id and wait for an acknowledgement</span></div>
<div class="line">SaveSentMessageId(message.MessageId);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Later, when an Acknowledgement has not been received</span></div>
<div class="line">record = ...;</div>
<div class="line">DeathRecordSubmission messageResend = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">messageResend.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line">messageResend.MessageId = RetrieveSentMessageId();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Resend the submission message</span></div>
<div class="line">...</div>
</div><!-- fragment --><p>One challenge with the above approach is ensuring that the same death record is sent in both the original and resent message. An alternative, that avoids this challenge, is to save the entire message as illustrated below:</p>
<div class="fragment"><div class="line"><span class="comment">// Create a DeathRecord</span></div>
<div class="line"><a class="code hl_class" href="class_v_r_d_r_1_1_death_record.html">DeathRecord</a> record = ...;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a submission message</span></div>
<div class="line">DeathRecordSubmission message = <span class="keyword">new</span> DeathRecordSubmission(record);</div>
<div class="line">message.MessageSource = <span class="stringliteral">&quot;https://example.com/jurisdiction/message/endpoint&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Send the submission message</span></div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Store the sent message and wait for an acknowledgement</span></div>
<div class="line">SaveSentMessage(message.<a class="code hl_property" href="class_v_r_d_r_1_1_base_message.html#a785b0c93a80f19853798c90a1dd14897">MessageId</a>, message.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#ad93e5924c25c3b1eb29c316a47e25f1d">ToJSON</a>());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Later, when an Acknowledgement has not been received</span></div>
<div class="line">var resendMsgId = GetUnacknowledgedMessageId();</div>
<div class="line">var messageResendJson = RetrieveSentMessage(resendMsgId);</div>
<div class="line">var messageResend = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageResendJson);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Resend the message</span></div>
<div class="line">...</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_base_message_html_a785b0c93a80f19853798c90a1dd14897"><div class="ttname"><a href="class_v_r_d_r_1_1_base_message.html#a785b0c93a80f19853798c90a1dd14897">VRDR.BaseMessage.MessageId</a></div><div class="ttdeci">string MessageId</div><div class="ttdoc">Message Id.</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:210</div></div>
</div><!-- fragment --><p>The above two approaches are also applicable to the case where a coding response or update needs to be resent.</p>
<h1><a class="anchor" id="autotoc_md141"></a>
Error Handling</h1>
<p>Errors found when parsing messages will be reported either via a <code>System.ArgumentException</code> or a <code><a class="el" href="class_v_r_d_r_1_1_message_parse_exception.html" title="An exception that may be thrown during message parsing.">VRDR.MessageParseException</a></code>. A <code>MessageParseException</code> encapsulates information from the message that caused the error. The exception can be used to construct a <code><a class="el" href="class_v_r_d_r_1_1_extraction_error_message.html" title="Class ExtractionErrorMessage is used to communicate that initial processing of a DeathRecordSubmissio...">VRDR.ExtractionErrorMessage</a></code> to report the error to the original sender of the message that caused the error. The code below illustrates this.</p>
<div class="fragment"><div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Try to parse an incoming message</span></div>
<div class="line">    var msg = <a class="code hl_class" href="class_v_r_d_r_1_1_base_message.html">BaseMessage</a>.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#a0d91912a93701d9daaf8e0ab6f3ea0f9">Parse</a>(messageStream);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code hl_class" href="class_v_r_d_r_1_1_message_parse_exception.html">MessageParseException</a> ex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Create a message to convey the error back to the original sender</span></div>
<div class="line">    <a class="code hl_class" href="class_v_r_d_r_1_1_extraction_error_message.html">ExtractionErrorMessage</a> errorReply = ex.<a class="code hl_function" href="class_v_r_d_r_1_1_message_parse_exception.html#aa6f04574e28a209480aca03a4d804198">CreateExtractionErrorMessage</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Validate completeness of error message</span></div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Serialize the error message</span></div>
<div class="line">    <span class="keywordtype">string</span> errorReplyJson = errorReply.<a class="code hl_function" href="class_v_r_d_r_1_1_base_message.html#ad93e5924c25c3b1eb29c316a47e25f1d">ToJSON</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Send the JSON message</span></div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="aclass_v_r_d_r_1_1_message_parse_exception_html"><div class="ttname"><a href="class_v_r_d_r_1_1_message_parse_exception.html">VRDR.MessageParseException</a></div><div class="ttdoc">An exception that may be thrown during message parsing.</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:787</div></div>
<div class="ttc" id="aclass_v_r_d_r_1_1_message_parse_exception_html_aa6f04574e28a209480aca03a4d804198"><div class="ttname"><a href="class_v_r_d_r_1_1_message_parse_exception.html#aa6f04574e28a209480aca03a4d804198">VRDR.MessageParseException.CreateExtractionErrorMessage</a></div><div class="ttdeci">ExtractionErrorMessage CreateExtractionErrorMessage()</div><div class="ttdoc">Build an ExtractionErrorMessage that conveys the issues reported in this exception.</div><div class="ttdef"><b>Definition</b> BaseMessage.cs:803</div></div>
</div><!-- fragment --><p>Note that only those properties that could be extracted from the original message will be used to populate the header fields of the error message, implementations should ensure that the error message header information is complete before sending. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
